<!-- Add Paper Modal -->
<div x-show="showAddModal" x-cloak
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6 max-h-[90vh] overflow-y-auto" @mousedown.away="showAddModal = false">
        <div class="flex justify-between items-start mb-2">
            <h3 class="text-lg font-semibold text-gray-900">Add New Paper</h3>
            <button @click="showAddModal = false" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        {% if user %}
        <div>
            <form x-data="addPaperForm()"
                  @submit.prevent="
                    fetch('/api/papers', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(buildPayload())
                    }).then(r => {
                        if(r.status < 400) { showAddModal = false; window.location = '/#' + formData.bibtex_key; window.location.reload(); }
                        else r.json().catch(() => null).then(d => alert(d?.detail || 'Error adding paper'));
                    })
                  "
                  class="space-y-3">
                <div>
                    <button type="button" @click="showBibtexParse = !showBibtexParse"
                        class="text-xs text-blue-600 hover:underline" x-text="showBibtexParse ? 'Cancel' : 'Parse from BibTeX'"></button>
                    <div x-show="showBibtexParse" x-cloak class="mt-2 space-y-2">
                        <textarea x-model="bibtexRaw" rows="6" placeholder="Paste BibTeX entry here..."
                            class="w-full rounded border-gray-300 text-gray-900 text-sm p-2 border font-mono focus:ring-blue-500 focus:border-blue-500"></textarea>
                        <button type="button" @click="parseBibtex()"
                            class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium rounded transition-colors">Parse</button>
                    </div>
                </div>
                <div x-show="formData.bibtex_key" x-cloak>
                    <span x-text="formData.bibtex_key"
                        class="bg-gray-100 px-1.5 py-0.5 rounded text-xs font-mono text-gray-700 select-all"></span>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Title *</label>
                    <input type="text" x-model="formData.title" required
                        class="w-full rounded border-gray-300 text-gray-900 text-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Authors * <span class="font-normal text-gray-400">— e.g. Albert Einstein and Kurt Gödel and Alan Turing</span></label>
                    <input type="text" x-model="formData.authors" required placeholder="Albert Einstein and Kurt Gödel and Alan Turing"
                        @blur="computeKey()"
                        class="w-full rounded border-gray-300 text-gray-900 text-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Year *</label>
                        <input type="text" x-model="formData.year" required
                            @blur="computeKey()"
                            class="w-full rounded border-gray-300 text-gray-900 text-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Journal</label>
                        <input type="text" x-model="formData.journal"
                            class="w-full rounded border-gray-300 text-gray-900 text-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Booktitle</label>
                        <input type="text" x-model="formData.booktitle"
                            class="w-full rounded border-gray-300 text-gray-900 text-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Publisher</label>
                        <input type="text" x-model="formData.publisher"
                            class="w-full rounded border-gray-300 text-gray-900 text-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Volume</label>
                        <input type="text" x-model="formData.volume"
                            class="w-full rounded border-gray-300 text-gray-900 text-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Number</label>
                        <input type="text" x-model="formData.number"
                            class="w-full rounded border-gray-300 text-gray-900 text-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Pages <span class="font-normal text-gray-400">e.g. 1--20</span></label>
                        <input type="text" x-model="formData.pages"
                            class="w-full rounded border-gray-300 text-gray-900 text-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">DOI</label>
                        <input type="text" x-model="formData.doi"
                            class="w-full rounded border-gray-300 text-gray-900 text-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">URL</label>
                        <input type="url" x-model="formData.url"
                            class="w-full rounded border-gray-300 text-gray-900 text-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Abstract</label>
                    <textarea x-model="formData.abstract" rows="3"
                        class="w-full rounded border-gray-300 text-gray-900 text-sm p-2 border focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Note</label>
                    <input type="text" x-model="formData.note"
                        class="w-full rounded border-gray-300 text-gray-900 text-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Entry Type (BibTeX)</label>
                    <div class="flex items-center gap-2">
                        <select x-model="entrySelect" @change="syncEntryType()" class="rounded border-gray-300 text-gray-900 text-sm p-2 border">
                            <option value="article">article</option>
                            <option value="inproceedings">inproceedings</option>
                            <option value="incollection">incollection</option>
                            <option value="book">book</option>
                            <option value="phdthesis">phdthesis</option>
                            <option value="mastersthesis">mastersthesis</option>
                            <option value="techreport">techreport</option>
                            <option value="misc">misc</option>
                            <option value="unpublished">unpublished</option>
                            <option value="__other__">other...</option>
                        </select>
                        <input x-show="entrySelect === '__other__'" x-cloak type="text" x-model="customType" @input="syncEntryType()"
                            placeholder="e.g. proceedings" class="flex-1 rounded border-gray-300 text-gray-900 text-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Extra Fields (BibTeX)</label>
                    <template x-for="(extra, i) in extras" :key="i">
                        <div class="flex gap-2 mb-1">
                            <input type="text" x-model="extras[i].key" placeholder="Key"
                                class="w-1/3 rounded border-gray-300 text-gray-900 text-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                            <input type="text" x-model="extras[i].value" placeholder="Value"
                                class="flex-1 rounded border-gray-300 text-gray-900 text-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                            <button type="button" @click="removeExtra(i)" class="text-red-400 hover:text-red-600 text-sm px-1">&times;</button>
                        </div>
                    </template>
                    <button type="button" @click="addExtra()"
                        class="text-xs text-blue-600 hover:underline">+ Add field</button>
                </div>
                {% if user and user.is_superuser %}
                <div class="bg-gray-50 border border-gray-200 rounded p-3 space-y-2">
                    <label class="flex items-center gap-2 text-xs font-medium text-gray-700 cursor-pointer">
                        <input type="checkbox" x-model="excluded" class="rounded border-gray-300 text-gray-600 focus:ring-gray-500">
                        Exclude from formalisation goal
                    </label>
                    <div x-show="excluded" x-cloak>
                        <input type="text" x-model="exclusionReason" placeholder="Reason for exclusion (e.g. duplicate, off-topic)"
                            class="w-full rounded border-gray-300 text-gray-900 text-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                {% endif %}
                <button type="submit"
                    class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors">
                    Add Paper
                </button>
            </form>
        </div>

        {% else %}
        <div class="text-gray-700">
            <p class="mb-4">You need to be logged in to add a paper.</p>
            <button @click="showAddModal = false; showAuthModal = true"
                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors">
                Log in
            </button>
        </div>
        {% endif %}
    </div>
</div>

{% raw %}<script>
function addPaperForm() {
    return {
        formData: { bibtex_key: '', entry_type: 'article', title: '', authors: '', year: '', journal: '', booktitle: '', publisher: '', volume: '', number: '', pages: '', doi: '', url: '', abstract: '', note: '', extra_fields: null },
        knownTypes: ['article','inproceedings','incollection','book','phdthesis','mastersthesis','techreport','misc','unpublished'],
        entrySelect: 'article',
        customType: '',
        excluded: false,
        exclusionReason: '',
        showBibtexParse: false,
        bibtexRaw: '',
        extras: [],

        syncEntryType() {
            this.formData.entry_type = this.entrySelect === '__other__' ? this.customType : this.entrySelect;
        },

        computeKey() {
            var a = this.formData.authors.trim();
            var y = this.formData.year.trim();
            if (!a || !y) { this.formData.bibtex_key = ''; return; }
            var names = a.split(/\s+and\s+/).map(function(n) {
                var words = n.trim().split(/\s+/);
                var last = words[words.length - 1];
                return last.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-zA-Z]/g, '');
            }).filter(function(n) { return n; });
            this.formData.bibtex_key = names.map(function(n) { return n.charAt(0).toUpperCase() + n.slice(1); }).join('') + y;
        },

        parseBibtex() {
            var raw = this.bibtexRaw.trim();
            if (!raw) return;

            // Extract entry type
            var typeMatch = raw.match(/^@(\w+)\s*\{/);
            if (!typeMatch) { alert('Could not parse BibTeX entry.'); return; }
            var entryType = typeMatch[1].toLowerCase();

            // Remove @type{key, prefix and trailing }
            var body = raw.replace(/^@\w+\s*\{[^,]*,/, '');
            body = body.replace(/\}\s*$/, '');

            // Parse fields
            var fields = {};
            var re = /(\w+)\s*=\s*/g;
            var m;
            while ((m = re.exec(body)) !== null) {
                var key = m[1].toLowerCase();
                var rest = body.slice(re.lastIndex);
                var val = '';
                if (rest[0] === '{') {
                    var depth = 0, i = 0;
                    for (; i < rest.length; i++) {
                        if (rest[i] === '{') depth++;
                        else if (rest[i] === '}') { depth--; if (depth === 0) break; }
                    }
                    val = rest.slice(1, i);
                } else if (rest[0] === '"') {
                    var end = rest.indexOf('"', 1);
                    val = rest.slice(1, end);
                } else {
                    var end2 = rest.search(/[,\s}]/);
                    val = end2 === -1 ? rest : rest.slice(0, end2);
                }
                // Strip double braces {{...}} -> content
                val = val.replace(/^\{(.*)\}$/, '$1');
                fields[key] = val.trim();
            }

            // Map author -> authors
            if (fields.author) { fields.authors = fields.author; delete fields.author; }

            // Populate known form fields
            var knownFields = ['title','authors','year','journal','booktitle','publisher','volume','number','pages','doi','url','abstract','note'];
            var self = this;
            knownFields.forEach(function(k) { if (fields[k] !== undefined) self.formData[k] = fields[k]; });

            // Entry type
            if (this.knownTypes.includes(entryType)) {
                this.entrySelect = entryType;
                this.formData.entry_type = entryType;
            } else {
                this.entrySelect = '__other__';
                this.customType = entryType;
                this.formData.entry_type = entryType;
            }

            // Remaining fields -> extras
            var allKnown = new Set(knownFields.concat(['author']));
            this.extras = [];
            Object.entries(fields).forEach(function(entry) {
                if (!allKnown.has(entry[0])) self.extras.push({ key: entry[0], value: entry[1] });
            });

            this.computeKey();
            this.showBibtexParse = false;
            this.bibtexRaw = '';
        },

        addExtra() { this.extras.push({ key: '', value: '' }); },
        removeExtra(i) { this.extras.splice(i, 1); },

        buildPayload() {
            this.syncEntryType();
            this.computeKey();
            var ef = {};
            this.extras.forEach(function(e) { if (e.key.trim()) ef[e.key.trim()] = e.value; });
            this.formData.extra_fields = Object.keys(ef).length ? ef : null;
            var payload = Object.assign({}, this.formData);
            payload.exclusion_reason = this.excluded ? this.exclusionReason : null;
            return payload;
        }
    };
}
</script>{% endraw %}
