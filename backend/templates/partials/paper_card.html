{% set fc_count = fc_map.get(paper.id, 0) if fc_map is defined else 0 %}
{% set rc_count = rc_map.get(paper.id, 0) if rc_map is defined else 0 %}
{% set is_excluded = paper.exclusion_reason is not none and paper.exclusion_reason != '' %}
<div id="{{ paper.bibtex_key }}"
    class="bg-white rounded-lg shadow-lg hover:shadow-xl transition-shadow duration-300 p-4 pb-2">
    <a name="{{ paper.bibtex_key }}"></a>

    <!-- Paper Type Badge + Status + Year -->
    <div class="flex justify-between items-start mb-3">
        <div class="flex space-x-2 items-center flex-wrap gap-y-1">
            <a href="#{{ paper.bibtex_key }}"
                class="bg-gray-100 px-1.5 py-0.5 rounded text-xs font-mono text-gray-700 select-all cursor-pointer hover:bg-gray-200 transition-colors"
                title="Click to go to this paper">{{ paper.bibtex_key }}</a>
            <!-- Formalisation Status Badge -->
            {% if paper.computed_status.value == 'formalising' %}
            <span class="inline-block bg-yellow-100 text-yellow-800 text-xs font-medium px-2 py-0.5 rounded">Being formalised</span>
            {% elif paper.computed_status.value == 'auditing' %}
            <span class="inline-block bg-blue-100 text-blue-800 text-xs font-medium px-2 py-0.5 rounded">Being audited</span>
            {% elif paper.computed_status.value == 'audited' %}
            <span class="inline-block bg-green-100 text-green-800 text-xs font-medium px-2 py-0.5 rounded">Formalised</span>
            {% endif %}
            {% if is_excluded %}
            <span x-data="{ show: false }" class="relative inline-flex">
                <button type="button" @click="show = !show"
                    class="inline-block bg-gray-100 text-gray-500 text-[10px] font-medium px-1.5 py-0.5 rounded cursor-pointer hover:bg-gray-200 transition-colors">Not in goal</button>
                <span x-show="show" x-cloak @click.away="show = false"
                    class="absolute left-0 top-6 z-10 w-56 bg-white border border-gray-200 rounded shadow-md p-2">
                    <span class="block text-xs font-bold text-gray-900 mb-0.5">Reason</span>
                    <span class="text-xs text-gray-600">{{ paper.exclusion_reason }}</span>
                </span>
            </span>
            {% endif %}
        </div>
        <span class="text-sm font-semibold text-gray-900">{{ paper.year or '' }}</span>
    </div>

    <!-- Title -->
    <h3 class="text-lg font-semibold text-gray-900 leading-tight math-content">{{ paper.title|latex_quotes }}</h3>

    <!-- Authors -->
    <p class="text-sm text-gray-600">
        <span class="font-medium">Authors:</span> {{ paper.authors }}
    </p>

    <!-- Venue Information -->
    {% if paper.venue %}
    <div class="venue-section">
        <p class="text-xs text-gray-600 mb-4 max-w-xl truncate">
            <span class="font-medium math-content" title="{{ paper.venue }}">{{ paper.venue }}</span>
        </p>
    </div>
    {% endif %}

    <!-- Links + action buttons -->
    <div class="flex flex-wrap gap-2 mt-auto justify-between items-center">
        <!-- Left: resource links -->
        <div class="flex flex-wrap gap-2">
            {% if paper.abstract %}
            <button onclick="cardToggle(this, 'abstract')"
                data-panel-btn="abstract"
                class="inline-flex items-center px-3 py-1 text-xs font-medium rounded transition-colors border border-gray-200 bg-gray-50 hover:bg-gray-100 text-gray-600">
                Abstract
            </button>
            {% else %}
            <span class="inline-flex items-center px-3 py-1 bg-blue-25 text-gray-400 text-xs font-medium rounded border border-blue-100">
                Abstract
            </span>
            {% endif %}

            {% if paper.doi %}
            <a href="{{ paper.doi if paper.doi.startswith('http') else 'https://doi.org/' ~ paper.doi }}"
                target="_blank"
                class="inline-flex items-center px-3 py-1 bg-blue-50 hover:bg-blue-100 text-blue-600 text-xs font-medium rounded transition-colors border border-blue-200">
                DOI
            </a>
            {% else %}
            <span class="inline-flex items-center px-3 py-1 bg-blue-25 text-gray-400 text-xs font-medium rounded border border-blue-100">
                DOI
            </span>
            {% endif %}

            {% if paper.url %}
            <a href="{{ paper.url }}" target="_blank"
                class="inline-flex items-center px-3 py-1 bg-blue-50 hover:bg-blue-100 text-blue-600 text-xs font-medium rounded transition-colors border border-blue-200">
                URL
            </a>
            {% else %}
            <span class="inline-flex items-center px-3 py-1 bg-blue-25 text-gray-400 text-xs font-medium rounded border border-blue-100">
                URL
            </span>
            {% endif %}

            <div class="relative">
                <button onclick="toggleBibMenu(this)"
                    class="inline-flex items-center px-3 py-1 bg-blue-50 hover:bg-blue-100 text-blue-600 text-xs font-medium rounded transition-colors border border-blue-200">
                    BibTeX <span class="ml-1">&#9662;</span>
                </button>
                <div class="bib-menu hidden absolute left-0 mt-1 bg-white rounded shadow-lg py-1 w-36 z-50 border border-gray-200">
                    <button onclick="fetch('/api/papers/{{ paper.bibtex_key }}/bibtex').then(r=>r.text()).then(t=>{navigator.clipboard.writeText(t);this.closest('.bib-menu').classList.add('hidden')})"
                        class="w-full text-left px-3 py-1.5 text-xs text-gray-700 hover:bg-gray-100">Copy</button>
                    <a href="/api/papers/{{ paper.bibtex_key }}/bibtex" download="{{ paper.bibtex_key }}.bib"
                        onclick="this.closest('.bib-menu').classList.add('hidden')"
                        class="block px-3 py-1.5 text-xs text-gray-700 hover:bg-gray-100">Download</a>
                </div>
            </div>

            <!-- Edit toggle -->
            {% if user %}
            <button onclick="cardToggle(this, 'edit', '/htmx/paper-edit/{{ paper.bibtex_key }}')"
                data-panel-btn="edit"
                class="inline-flex items-center px-3 py-1 text-xs font-medium rounded transition-colors border border-yellow-200 bg-yellow-50 hover:bg-yellow-100 text-yellow-700 cursor-pointer">
                Edit
            </button>
            {% else %}
            <button onclick="document.body._x_dataStack[0].showAuthModal = true"
                class="inline-flex items-center px-3 py-1 bg-yellow-50 hover:bg-yellow-100 text-yellow-700 text-xs font-medium rounded transition-colors border border-yellow-200 cursor-pointer">
                Edit
            </button>
            {% endif %}
        </div>

        <!-- Right: review & formalisation summary buttons -->
        <div class="flex gap-2">
            <button onclick="cardToggle(this, 'details', '/htmx/paper-detail/{{ paper.bibtex_key }}?tab=reviews{% if rc_count == 0 %}&add=true{% endif %}')"
                class="inline-flex items-center gap-1 px-2.5 py-1 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 text-xs font-medium rounded transition-colors border border-indigo-200 cursor-pointer">
                <span id="rc-text-{{ paper.bibtex_key }}">{% if rc_count %}{{ rc_count }} review{{ 's' if rc_count != 1 else '' }}{% else %}Add review{% endif %}</span>
            </button>
            <button onclick="cardToggle(this, 'details', '/htmx/paper-detail/{{ paper.bibtex_key }}?tab=formalisations{% if fc_count == 0 %}&add=true{% endif %}')"
                class="inline-flex items-center gap-1 px-2.5 py-1 bg-purple-50 hover:bg-purple-100 text-purple-700 text-xs font-medium rounded transition-colors border border-purple-200 cursor-pointer">
                <span id="fc-text-{{ paper.bibtex_key }}">{% if fc_count %}{{ fc_count }} formalisation{{ 's' if fc_count != 1 else '' }}{% else %}Add formalisation{% endif %}</span>
            </button>
        </div>
    </div>

    <!-- Abstract panel -->
    {% if paper.abstract %}
    <div data-panel="abstract" class="hidden mt-3 border-t border-gray-200 pt-3">
        <p class="text-sm text-gray-700 math-content">{{ paper.abstract }}</p>
    </div>
    {% endif %}

    <!-- Dynamic detail/edit area -->
    <div id="detail-{{ paper.bibtex_key }}" data-panel="detail-target" class="mt-3"></div>
</div>
