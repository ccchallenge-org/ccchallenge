{% extends "_layout.html" %}

{% block title %}ccchallenge{% endblock %}

{% block content %}
<div>
    <!-- Header Section -->
    <div class="text-left mb-8 px-2 font-mono">
        <h1 class="underline">Challenge goal</h1>
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
            <p class="text-blue-100 max-w-4xl">
                Formalised results: <span id="formalised-count">{{ papers|selectattr('formalisations_count', 'gt',
                    0)|list|length }}</span> /
                <span id="total-count">{{ papers|length }}</span>.
            </p>


        </div>
    </div>

    <div class="flex justify-center items-center mb-8">
        <!-- Curation Selector -->
        <div class="flex items-center gap-2">
            <label for="curation-select" class="text-blue-100 text-sm">Curation:</label>
            <select id="curation-select"
                class="bg-white text-gray-900 px-3 py-1 rounded border border-gray-300 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                {% for curation in curations %}
                <option value="{{ curation.slug }}" data-papers="{{ curation.curation|join(',') }}" {% if
                    curation.slug=='ccchallenge' %}selected{% endif %}>
                    {{ curation.name }} ({{ curation.curation|length }})
                </option>
                {% endfor %}
                <option value="">All ({{ papers|length }})</option>
            </select>
        </div>
    </div>

    <!-- Papers Grid -->
    <div id="papers-grid" class="grid grid-cols-1 gap-4 max-w-3xl mx-auto">
        {% for paper in papers %}
        <div id="{{ paper.id }}"
            class="bg-white rounded-lg shadow-lg hover:shadow-xl transition-shadow duration-300 p-4 pb-2">
            <!-- Paper Type Badge -->
            <div class="flex justify-between items-start mb-3">
                <div class="flex space-x-3">
                    <span
                        class="inline-block bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded uppercase">
                        {{ paper.type }}
                    </span>
                    <!-- BibKey -->
                    <code
                        class="bg-gray-100 px-1.5 py-0.5 rounded text-xs font-mono text-gray-700 select-all cursor-pointer"
                        title="Click to select citation key">{{ paper.id }}</code>

                </div>
                <span class="text-sm font-semibold text-gray-900">{{ paper.year }}</span>
            </div>

            <!-- Title -->
            <h3 class="text-lg font-semibold text-gray-900 leading-tight math-content">
                {{ paper.title }}
            </h3>

            <!-- Authors -->
            <p class="text-sm text-gray-600">
                <span class="font-medium">Authors:</span> {{ paper.authors }}
            </p>

            <!-- Venue Information -->
            <div class="venue-section">
                {% if paper.venue %}
                <p class="text-xs text-gray-600 mb-4 max-w-xl truncate">
                    <span class="font-medium" title="{{ paper.venue }}">{{ paper.venue }}</span>
                </p>
                {% endif %}
            </div>

            <!-- Abstract Preview -->
            <!-- {% if paper.abstract %}
            <p class="text-sm text-gray-700 mb-4 line-clamp-3">
                {{ paper.abstract[:150] }}{% if paper.abstract|length > 150 %}...{% endif %}
            </p>
            {% endif %} -->

            <!-- Links -->
            <div class="flex flex-wrap gap-2 mt-auto justify-between items-center">
                <!-- Left-hand side buttons (discrete) -->
                <div class="flex flex-wrap gap-2">
                    {% if paper.doi %}
                    <a href="{{ paper.doi if paper.doi.startswith('http') else 'https://doi.org/' + paper.doi }}"
                        target="_blank"
                        class="inline-flex items-center px-3 py-1 bg-blue-50 hover:bg-blue-100 text-blue-600 text-xs font-medium rounded transition-colors border border-blue-200">
                        ðŸ“„ DOI
                    </a>
                    {% else %}
                    <span
                        class="inline-flex items-center px-3 py-1 bg-blue-25  text-gray-400 text-xs font-medium rounded border border-blue-100">
                        ðŸ“„ DOI
                    </span>
                    {% endif %}

                    {% if paper.url %}
                    <a href="{{ paper.url }}" target="_blank"
                        class="inline-flex items-center px-3 py-1 bg-blue-50 hover:bg-blue-100 text-blue-600 text-xs font-medium rounded transition-colors border border-blue-200">
                        ðŸ”— URL
                    </a>
                    {% else %}
                    <span
                        class="inline-flex items-center px-3 py-1 bg-blue-25 text-gray-400 text-xs font-medium rounded border border-blue-100">
                        ðŸ”— URL
                    </span>
                    {% endif %}

                    <button
                        class="download-bibtex inline-flex items-center px-3 py-1 bg-blue-50 hover:bg-blue-100 text-blue-600 text-xs font-medium rounded transition-colors border border-blue-200"
                        data-id="{{ paper.id }}" data-bibtex="{{ paper.raw_bibtex|e }}">
                        ðŸ“‹ BibTeX
                    </button>
                </div>

                <!-- Right-hand side button (important) -->
                <div class="flex items-center">
                    <button
                        class="inline-flex items-center px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-semibold rounded-lg transition-colors shadow-sm">
                        {{ paper.formalisations_count }} Formal Proofs
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- No Papers Message -->
    {% if not papers %}
    <div class="text-center py-12">
        <div class="text-gray-400 text-6xl mb-4">ðŸ“š</div>
        <h3 class="text-xl font-medium text-white mb-2">No Papers Found</h3>
        <p class="text-blue-100">The Collatz_conjecture.bib file couldn't be loaded or is empty.</p>
    </div>
    {% endif %}
</div>

<!-- Custom CSS for line clamping -->
<style>
    .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>

<script>
    // Store all papers data for filtering
    const allPapers = {{ papers| tojson }};

    // Handle BibTeX download buttons
    function setupBibtexButtons() {
        document.querySelectorAll('.download-bibtex').forEach(button => {
            button.addEventListener('click', function () {
                const paperId = this.dataset.id;
                const bibtexContent = this.dataset.bibtex;

                // Create a downloadable file
                const blob = new Blob([bibtexContent], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);

                // Create a temporary link and click it
                const link = document.createElement('a');
                link.href = url;
                link.download = `${paperId}.bib`;
                document.body.appendChild(link);
                link.click();

                // Clean up
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
            });
        });
    }

    // Helper function to create venue HTML
    function createVenueHtml(venue) {
        if (!venue) return '';
        return `<p class="text-xs text-gray-600 mb-4 max-w-xl truncate">
                    <span class="font-medium" title="${venue.replace(/"/g, '&quot;')}">${venue}</span>
                </p>`;
    }

    // Create paper HTML element
    function createPaperElement(paper) {
        return `
            <div id="${paper.id}" class="bg-white rounded-lg shadow-lg hover:shadow-xl transition-shadow duration-300 p-4 pb-2">
                <!-- Paper Type Badge -->
                <div class="flex justify-between items-start mb-3">
                    <div class="flex space-x-3">
                        <span class="inline-block bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded uppercase">
                            ${paper.type}
                        </span>
                        <!-- BibKey -->
                        <code class="bg-gray-100 px-1.5 py-0.5 rounded text-xs font-mono text-gray-700 select-all cursor-pointer" title="Click to select citation key">${paper.id}</code>
                    </div>
                    <span class="text-sm font-semibold text-gray-900">${paper.year}</span>
                </div>

                <!-- Title -->
                <h3 class="text-lg font-semibold text-gray-900 leading-tight math-content">
                    ${paper.title}
                </h3>

                <!-- Authors -->
                <p class="text-sm text-gray-600">
                    <span class="font-medium">Authors:</span> ${paper.authors}
                </p>

                <!-- Venue Information -->
                ${createVenueHtml(paper.venue)}

                <!-- Links -->
                <div class="flex flex-wrap gap-2 mt-auto justify-between items-center">
                    <!-- Left-hand side buttons (discrete) -->
                    <div class="flex flex-wrap gap-2">
                        ${paper.doi ? `
                        <a href="${paper.doi.startsWith('http') ? paper.doi : 'https://doi.org/' + paper.doi}"
                            target="_blank"
                            class="inline-flex items-center px-3 py-1 bg-blue-50 hover:bg-blue-100 text-blue-600 text-xs font-medium rounded transition-colors border border-blue-200">
                            ðŸ“„ DOI
                        </a>
                        ` : `
                        <span class="inline-flex items-center px-3 py-1 bg-blue-25 text-gray-400 text-xs font-medium rounded border border-blue-100">
                            ðŸ“„ DOI
                        </span>
                        `}

                        ${paper.url ? `
                        <a href="${paper.url}" target="_blank"
                            class="inline-flex items-center px-3 py-1 bg-blue-50 hover:bg-blue-100 text-blue-600 text-xs font-medium rounded transition-colors border border-blue-200">
                            ðŸ”— URL
                        </a>
                        ` : `
                        <span class="inline-flex items-center px-3 py-1 bg-blue-25 text-gray-400 text-xs font-medium rounded border border-blue-100">
                            ðŸ”— URL
                        </span>
                        `}

                        <button class="download-bibtex inline-flex items-center px-3 py-1 bg-blue-50 hover:bg-blue-100 text-blue-600 text-xs font-medium rounded transition-colors border border-blue-200"
                                data-id="${paper.id}" data-bibtex="${paper.raw_bibtex.replace(/"/g, '&quot;')}">
                            ðŸ“‹ BibTeX
                        </button>
                    </div>

                    <!-- Right-hand side button (important) -->
                    <div class="flex items-center">
                        <button class="inline-flex items-center px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-semibold rounded-lg transition-colors shadow-sm">
                            ${paper.formalisations_count} Formal Proofs
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // Filter papers based on curation
    function filterPapers(curationSlug) {
        const grid = document.getElementById('papers-grid');
        const select = document.getElementById('curation-select');

        let filteredPapers = allPapers;

        if (curationSlug) {
            const selectedOption = select.querySelector(`option[value="${curationSlug}"]`);
            const paperIds = selectedOption.dataset.papers.split(',');
            filteredPapers = allPapers.filter(paper => paperIds.includes(paper.id));
        }

        // Update the grid
        grid.innerHTML = filteredPapers.map(createPaperElement).join('');

        // Update counts
        const formalised = filteredPapers.filter(p => p.formalisations_count > 0).length;
        document.getElementById('formalised-count').textContent = formalised;
        document.getElementById('total-count').textContent = filteredPapers.length;

        // Re-setup bibtex buttons for new elements
        setupBibtexButtons();
    }

    // Initialize everything when page loads
    document.addEventListener('DOMContentLoaded', function () {
        // Setup initial bibtex buttons
        setupBibtexButtons();

        // Setup curation selector
        const curationSelect = document.getElementById('curation-select');
        curationSelect.addEventListener('change', function () {
            filterPapers(this.value);
        });

        // Initial render with default selected curation (ccchallenge)
        const defaultCuration = curationSelect.value || 'ccchallenge';
        filterPapers(defaultCuration);
    });
</script>
{% endblock %}